import{h as defineComponent,w as ref,r as reactive,F as onMounted,a6 as onUnmounted,q as resolveComponent,o as openBlock,k as createElementBlock,m as createBaseVNode,p as createVNode,z as unref,Q as withCtx,t as isRef,aH as search_default,P as createBlock,Z as createTextVNode,V as toDisplayString,a0 as pushScopeId,a1 as popScopeId}from"./vue-974988d6.js";import{l as loadSVGData,a as addGateway,u as updateGateway,f as addTag,r as runGateway,g as runTag}from"./map-a5492c66.js";import{c as useI18n_1,ag as init,_ as _export_sfc}from"./index-1515df1a.js";import{F as FormItem}from"./index-a773531e.js";import{m as getMap,n as getGatewaybyMap}from"./index-24a0fd9a.js";import tagDrawer from"./DeviceDrawer-4e4063d2.js";import"./sass.default-e4c9116c.js";import"./moment-fbc5633a.js";import"./index-11ae6512.js";import"./index-7182f49c.js";const _withScopeId=o=>(pushScopeId("data-v-1dd7153f"),o=o(),popScopeId(),o),_hoisted_1=_withScopeId(()=>createBaseVNode("div",{id:"container"},null,-1)),_hoisted_2=_withScopeId(()=>createBaseVNode("div",{id:"main",class:"hdmrboxtm-mbox",viewBox:"0 0 1000 1000"},null,-1)),_hoisted_3={class:"dataCount"},_hoisted_4={style:{"background-color":"#ffffff"}},_hoisted_5={style:{"margin-top":"20px","margin-left":"10px","margin-right":"10px"}},_hoisted_6={style:{"margin-left":"10px","margin-right":"10px"}},_sfc_main=defineComponent({__name:"index",setup(__props){const{t}=useI18n_1();ref("");const Gateways_map=new Map;let gateway_show=ref(!0),gateway_filter=ref(""),Gateways=reactive([]);const tag_map=new Map;let tag_show=ref(!0),tag_filter=ref(""),tags=reactive([]);var proportion,map_key,ws;function getHeight(){return window.innerHeight-250}ref(!0),onMounted(()=>{init();var ip=window.location.host;ip=ip.replaceAll("http://",""),console.log("IP="+ip),ip=ip.replaceAll(":706",""),console.log("IP="+ip),ip=ip.replaceAll(":71",""),ip=ip.replaceAll(":701",""),console.log("IP="+ip),ip="ws://"+ip+":7089",console.log("IP="+ip),ws=new WebSocket(ip),console.log("尝试连接"+ws),ws.onopen=function(o){console.log("Connection open ...链接完成7089")},ws.onmessage=function(e){console.log("服务器返回的信息: "+e.data);var json=eval("("+e.data+")");addTag1(json)},setTimeout(function(){getMap().then(o=>{o.data.length>0&&onRemoteSelectRow(o.data[0])})},1e3)}),onUnmounted(()=>{console.log("断开"),ws.close()});const onRemoteSelectRow=o=>{console.log(o),Gateways.splice(0,Gateways.length),gateway_show.value=!0,Gateways_map.clear(),gateway_filter.value="",tags.splice(0,tags.length),tag_show.value=!0,tag_map.clear(),tag_filter.value="",proportion=o.proportion,loadSVGData(o.data),map_key=o.map_key,getGatewaybyMap(o.map_key).then(a=>{if(a.data.length>0)for(var l=0;l<a.data.length;l++){const n={address:a.data[l].address,name:a.data[l].name,x:a.data[l].x,y:a.data[l].y,proportion,show:!1,online:a.data[l].online,last_time:0,type:1};n.show=gateway_show.value,Gateways_map.set(n.address,n),Gateways.push(n),addGateway(n)}}).finally(()=>{}),setInterval(intervalUpdate,5e3),setTimeout(function(){ws.send(map_key+"-666-"+Math.random()*100)},1e3)},gateway_row_click=o=>{runGateway(o.address)},tag_row_click=o=>{runTag(o.address)};function intervalUpdate(){getGatewaybyMap(map_key).then(o=>{if(o.data.length>0)for(var a=0;a<o.data.length;a++){const l={address:o.data[a].address,name:o.data[a].name,x:o.data[a].x,y:o.data[a].y,proportion,show:!1,type:1,online:o.data[a].online,last_time:o.data[a].lasttime};Gateways_map.get(l.address)!=null&&gateway_show.value&&(l.name.includes(gateway_filter.value)||l.address.includes(gateway_filter.value)?l.show=gateway_show.value:l.show=!1),Gateways_map.set(l.address,l),updateGateway(l)}}).finally(()=>{})}const switch_gateway=o=>{Gateways.forEach(function(a,l){a.show=!1,updateGateway(a)}),Gateways.splice(0,Gateways.length),Gateways_map.forEach(function(a,l){console.log(a.name+"==="+gateway_filter.value),a.show=!1,(a.name.includes(gateway_filter.value)||a.address.includes(gateway_filter.value))&&o&&(a.show=o,console.log("包含"+a.show),Gateways.push(a),Gateways_map.set(l,a),updateGateway(a))})},search_gateway=o=>{Gateways.forEach(function(a,l){var n=a.show;a.show=!1,updateGateway(a),a.show=n}),gateway_filter.value=o,console.log(o),Gateways.splice(0,Gateways.length),Gateways_map.forEach(function(a,l){console.log(a.name+"==="+gateway_filter.value),(a.name.includes(gateway_filter.value)||a.address.includes(gateway_filter.value))&&(console.log("包含"+a.show),gateway_show.value&&(console.log("包含"+a.address),a.show=!0,Gateways.push(a),Gateways_map.set(l,a),updateGateway(a)))})},switch_tag=o=>{tags.forEach(function(a,l){a.show=!1,addTag(a)}),tags.splice(0,tags.length),tag_map.forEach(function(a,l){console.log(a.name+"==="+tag_filter.value),a.show=!1,a.address.includes(tag_filter.value)&&o&&(a.show=o,console.log("包含"+a.show),tags.push(a),tag_map.set(l,a),addTag(a))})},search_tag=o=>{tags.forEach(function(a,l){var n=a.show;a.show=!1,addTag(a),a.show=n}),tag_filter.value=o,console.log(o),tags.splice(0,tags.length),tag_map.forEach(function(a,l){console.log(a.name+"==="+tag_filter.value),a.address.includes(tag_filter.value)&&(console.log("包含"+a.show),tag_show.value&&(console.log("包含"+a.address),a.show=!0,tags.push(a),tag_map.set(l,a),addTag(a)))})};function addTag1(o){if(console.log(o),o.tag.length>0)for(var a=0;a<o.tag.length;a++){if(map_key!=o.tag[a].map_key)return;const n={address:o.tag[a].mac,x:o.tag[a].x,y:o.tag[a].y,proportion,online:o.tag[a].online,last_time:o.tag[a].lastTime,sos:o.tag[a].sos,bt:o.tag[a].bt};var l=tag_map.get(n.address);l!=null?(n.show=!1,n.address.includes(tag_filter.value)&&tag_show.value&&(n.show=tag_show.value)):(tags.push(n),tag_map.set(n.address,n)),addTag(n)}}let show=ref(!1);var TreeData=Array;function getChange(o){show.value=!1}return(o,a)=>{const l=resolveComponent("el-input"),n=resolveComponent("el-switch"),r=resolveComponent("el-table-column"),d=resolveComponent("el-tag"),i=resolveComponent("el-table"),c=resolveComponent("el-tab-pane"),p=resolveComponent("el-tabs");return openBlock(),createElementBlock("div",null,[_hoisted_1,_hoisted_2,createBaseVNode("div",_hoisted_3,[createBaseVNode("div",_hoisted_4,[createBaseVNode("div",_hoisted_5,[createVNode(FormItem,{label:unref(t)("file"),type:"remoteSelect","input-attr":{multiple:!1,pk:"id",field:"name","remote-url":"/userApi/map/index2?aa="+Math.random(),onRow:onRemoteSelectRow},"default:":"",placeholder:unref(t)("file")},null,8,["label","input-attr","placeholder"])]),createBaseVNode("div",_hoisted_6,[createVNode(p,{type:"border-card"},{default:withCtx(()=>[createVNode(c,{label:unref(t)("tag_name")},{default:withCtx(()=>[createBaseVNode("div",null,[createVNode(l,{modelValue:unref(tag_filter),"onUpdate:modelValue":a[0]||(a[0]=s=>isRef(tag_filter)?tag_filter.value=s:tag_filter=s),clearable:"",style:{width:"80%"},placeholder:unref(t)("gateway_name")+"/"+unref(t)("code_sn"),"suffix-icon":unref(search_default),onInput:search_tag},null,8,["modelValue","placeholder","suffix-icon"]),createVNode(n,{modelValue:unref(tag_show),"onUpdate:modelValue":a[1]||(a[1]=s=>isRef(tag_show)?tag_show.value=s:tag_show=s),onChange:switch_tag,style:{"margin-left":"10px"}},null,8,["modelValue"])]),createBaseVNode("div",null,[createVNode(i,{data:unref(tags),height:getHeight(),onRowClick:tag_row_click},{default:withCtx(()=>[createVNode(r,{prop:"address",label:unref(t)("tag_address")},null,8,["label"]),createVNode(r,{prop:"online",label:unref(t)("State"),width:"60",render:"tag"},{default:withCtx(s=>[s.row.online=="1"?(openBlock(),createBlock(d,{key:0,type:"success","disable-transitions":""},{default:withCtx(()=>[createTextVNode(toDisplayString(unref(t)("online")),1)]),_:1})):(openBlock(),createBlock(d,{key:1,type:"info","disable-transitions":""},{default:withCtx(()=>[createTextVNode(toDisplayString(unref(t)("unline")),1)]),_:1}))]),_:1},8,["label"])]),_:1},8,["data","height"])])]),_:1},8,["label"]),createVNode(c,{label:unref(t)("gateway")},{default:withCtx(()=>[createBaseVNode("div",null,[createVNode(l,{modelValue:unref(gateway_filter),"onUpdate:modelValue":a[2]||(a[2]=s=>isRef(gateway_filter)?gateway_filter.value=s:gateway_filter=s),clearable:"",style:{width:"80%"},placeholder:unref(t)("gateway_name")+"/"+unref(t)("code_sn"),"suffix-icon":unref(search_default),onInput:search_gateway},null,8,["modelValue","placeholder","suffix-icon"]),createVNode(n,{modelValue:unref(gateway_show),"onUpdate:modelValue":a[3]||(a[3]=s=>isRef(gateway_show)?gateway_show.value=s:gateway_show=s),onChange:switch_gateway,style:{"margin-left":"10px"}},null,8,["modelValue"])]),createBaseVNode("div",null,[createVNode(i,{data:unref(Gateways),height:getHeight(),onRowClick:gateway_row_click},{default:withCtx(()=>[createVNode(r,{prop:"name",label:unref(t)("gateway_name")},null,8,["label"]),createVNode(r,{prop:"address",label:unref(t)("gateway_mac")},null,8,["label"]),createVNode(r,{prop:"online",label:unref(t)("State"),width:"60",render:"tag"},{default:withCtx(s=>[s.row.online=="1"?(openBlock(),createBlock(d,{key:0,type:"success","disable-transitions":""},{default:withCtx(()=>[createTextVNode(toDisplayString(unref(t)("online")),1)]),_:1})):(openBlock(),createBlock(d,{key:1,type:"info","disable-transitions":""},{default:withCtx(()=>[createTextVNode(toDisplayString(unref(t)("unline")),1)]),_:1}))]),_:1},8,["label"])]),_:1},8,["data","height"])])]),_:1},8,["label"])]),_:1})])])]),createVNode(tagDrawer,{show:unref(show),"onUpdate:show":a[4]||(a[4]=s=>isRef(show)?show.value=s:show=s),TreeData:unref(TreeData),onGetChange:getChange},null,8,["show","TreeData"])])}}}),index_vue_vue_type_style_index_0_scoped_1dd7153f_lang="",index_vue_vue_type_style_index_1_lang="",index_vue_vue_type_style_index_2_lang="",index=_export_sfc(_sfc_main,[["__scopeId","data-v-1dd7153f"]]);export{index as default};
